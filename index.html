<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Private Chat</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#eef1f4;
}

.chat{
  width:100%;
  max-width:420px;
  height:100vh;
  margin:auto;
  background:#fff;
  display:flex;
  flex-direction:column;
}

.header{
  background:#1976d2;
  color:#fff;
  padding:14px;
  font-weight:bold;
  text-align:center;
}

.msgs{
  flex:1;
  padding:12px;
  overflow-y:auto;
  background:#f7f9fb;
}

.msg{
  max-width:75%;
  margin:6px 0;
  padding:10px 14px;
  border-radius:18px;
  font-size:14px;
  word-wrap:break-word;
}

.user{
  background:#e3f2fd;
  margin-left:auto;
}

.admin{
  background:#c8e6c9;
}

.input{
  border-top:1px solid #ddd;
  padding:10px;
}

.row{
  display:flex;
  gap:6px;
}

.row input[type=text]{
  flex:1;
  padding:10px 14px;
  border-radius:20px;
  border:1px solid #ccc;
}

.row button{
  border:none;
  background:#1976d2;
  color:#fff;
  padding:0 16px;
  border-radius:20px;
  font-weight:bold;
}

.file{
  margin-top:6px;
}

#export{
  display:none;
  margin:10px;
  background:#2e7d32;
  color:#fff;
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:bold;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>

<body>

<div class="chat">
  <div class="header" id="title">Chat</div>

  <div class="msgs" id="msgs"></div>

  <div class="input">
    <div class="row">
      <input id="text" type="text" placeholder="Nháº­p tin nháº¯n...">
      <button onclick="send()">Gá»­i</button>
    </div>
    <div class="file">
      <input type="file" id="file">
    </div>
  </div>

  <button id="export" onclick="exportExcel()">Xuáº¥t Excel</button>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT.firebaseio.com",
  projectId: "PROJECT",
  storageBucket: "PROJECT.appspot.com"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const storage = firebase.storage();

/* ================= ROLE ================= */
const isAdmin = location.hash === "#admin";
title.innerText = isAdmin ? "Admin Inbox" : "Chat vá»›i Admin";
if(isAdmin) document.getElementById("export").style.display="block";

/* ================= USER ID (KHÃ”NG Máº¤T CHAT) ================= */
let uid = localStorage.getItem("chat_uid");
if(!uid){
  uid = "uid_" + Date.now() + "_" + Math.random().toString(36).slice(2);
  localStorage.setItem("chat_uid", uid);
}

/* ================= DATABASE REF ================= */
const userRef = db.ref("sessions/" + uid + "/messages");

/* ================= LOAD MESSAGE ================= */
function render(m){
  const d = document.createElement("div");
  d.className = "msg " + (m.from === "admin" ? "admin" : "user");

  if(m.type === "file"){
    d.innerHTML = `ðŸ“Ž <a href="${m.url}" target="_blank">${m.name}</a>`;
  }else{
    d.innerText = m.text;
  }

  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

if(isAdmin){
  db.ref("sessions").on("child_added", s=>{
    s.child("messages").forEach(m=>render(m.val()));
    s.ref.child("messages").on("child_added", m=>render(m.val()));
  });
}else{
  userRef.on("child_added", s=>render(s.val()));
}

/* ================= SEND ================= */
function send(){
  if(text.value){
    userRef.push({
      text: text.value,
      from: isAdmin ? "admin" : "user",
      time: Date.now()
    });
    db.ref("notify").set({new:true});
    text.value="";
  }

  if(file.files.length){
    const f = file.files[0];
    const ref = storage.ref("uploads/"+uid+"/"+f.name);
    ref.put(f).then(()=>{
      ref.getDownloadURL().then(url=>{
        userRef.push({
          type:"file",
          name:f.name,
          url:url,
          from:isAdmin?"admin":"user",
          time:Date.now()
        });
      });
    });
    file.value="";
  }
}

/* ================= ADMIN NOTIFY ================= */
if(isAdmin){
  db.ref("notify").on("value", s=>{
    if(s.val()?.new){
      alert("ðŸ“© CÃ³ tin nháº¯n má»›i");
      db.ref("notify").set({new:false});
    }
  });
}

/* ================= EXPORT EXCEL ================= */
function exportExcel(){
  db.ref("sessions").once("value", snap=>{
    let csv="UID,From,Content,Time\n";
    snap.forEach(s=>{
      s.child("messages").forEach(m=>{
        const v=m.val();
        csv+=`${s.key},${v.from},${v.text||v.name},${new Date(v.time)}\n`;
      });
    });
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="chat_log.csv";
    a.click();
  });
}
</script>

</body>
</html>
